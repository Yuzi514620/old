!function(){"use strict";class e{constructor(n){this.reading_time_interval=10,this.reading_time_max=86400,this.sn_cookies={sn_uid:"sn_uid"},this.sn_domain="https://sn.bnextmedia.com.tw",this.sn_rec_domain="https://sn-rec.bnextmedia.com.tw",this.salmon_conf=n,"v"in this.salmon_conf||(this.salmon_conf.v=2),"m_id"in this.salmon_conf||(this.salmon_conf.m_id=""),"is_sent_reading_time"in this.salmon_conf||(this.salmon_conf.is_sent_reading_time=!0),this.sn_uid="",this.jsc=(new Date).getTime(),this.pv_id="",this.reading_intervals=0,this.reading_timer=!1,this.reading_scrollY=0,this.pages={};for(var i=1;i<=20;i++)this.pages[i]={pv_id:null,queue:[]};e.log("initial!")}init_reading_time(){!1!==this.reading_timer&&clearInterval(this.reading_timer),this.reading_intervals=0,this.reading_scrollY=0,this.reading_timer=setInterval((()=>{var e=window.scrollY||document.body.scrollTop||0;this.reading_intervals++,this.send_reading_time(e!=this.reading_scrollY),this.reading_scrollY=e}),1e3*this.reading_time_interval)}send_page_view(e="",n="",i=1){e||(e=window.location.href),n||(n=document.referrer);var s={ac:"page_view",url:e,referrer:n,page:i},t=`${Date.now()}.${this.random()}`;for(var a of(this.pv_id=t,i in this.pages?this.pages[i].pv_id=t:this.pages[i]={pv_id:t,queue:[]},this.send_event(s,"ac=page_view"),this.salmon_conf.is_sent_reading_time&&this.init_reading_time(),this.pages[i].queue))this.send_event(this.pages[i].queue[a].event_parms,this.pages[i].queue[a].extra_parms);this.pages[i].queue=[]}send_reading_time(e){var n=this.reading_intervals*this.reading_time_interval;0!=this.reading_time_max&&n>=this.reading_time_max&&(n=this.reading_time_max,clearInterval(this.reading_timer));var i={ac:"reading_time",reading_time:n,is_scrolled:e};this.send_event(i,"ac=reading_time")}send_reading_pct(n){if((n=Math.round(n))>=0&&n<=100){var i={ac:"reading_pct",reading_pct:n};this.send_event(i,"ac=reading_pct")}else e.log("pct is invalid")}send_privacy_agreement(e){e||(e=window.location.host);var n={ac:"agree_privacy",site:e};this.send_event(n,"ac=agree_privacy")}send_universal_event(n="",i="",s="",t=0,a=null){if(n)if("number"==typeof t){var r={ac:"universal",category:n,action:i,label:s,value:t,page_order:a};this.send_event(r,"ac=universal")}else e.log("value is invalid");else e.log("category is invalid")}send_event(n,i){if(this.sn_uid)e.log(`use retrieved sn_uid: ${this.sn_uid}`),this.send(n,i);else{var s=this.retrieve_cookie(this.sn_cookies.sn_uid);s?(this.sn_uid=s,e.log(`use retrieved sn_uid: ${this.sn_uid}`),this.send(n,i)):this.jsp({url:this.sn_domain+"/cm/gc",data:{},callback:s=>{(s=JSON.parse(s)).uid&&(this.sn_uid=s.uid,e.log(`use requested sn_uid: ${this.sn_uid}`),this.create_cookie(this.sn_cookies.sn_uid,this.sn_uid,2592e3,"/",!1,!0),this.send(n,i))}},"jsoncallback")}}send(n={},i){if(i||(i=""),n.sn_uid=this.sn_uid,n.sn_channel_domain=window.top.location.host,n.v=this.salmon_conf.v,n.m_id=this.salmon_conf.m_id,n.time=n.time||Date.now(),n.random=n.random||this.random(),n.page_order){if(!(n.page_order in this.pages))return this.pages[n.page_order]={pv_id:null,queue:[{event_parms:n,extra_parms:i}]},!1;if(!this.pages[n.page_order].pv_id)return this.pages[n.page_order].queue.push({event_parms:n,extra_parms:i}),!1;n.pv_id=this.pages[n.page_order].pv_id}else n.pv_id=this.pv_id;var s="";if(i.length>0&&(s="&"+i),n.ac){var t=JSON.stringify(n),a=btoa(encodeURI(t)),r=this.salmon_conf.is_remote_log?this.sn_rec_domain:window.location.origin;r+="/salmon.png?msg="+a+s;var o=document.createElement("IMG");o.src=r,o.id="tc-img",o.style.cssText="display: none;",document.getElementsByTagName("body")[0].appendChild(o),"universal"==n.ac?e.log(`sent ${n.ac}.${n.category} event`):e.log(`sent ${n.ac} event`)}else e.log("ac param not found")}retrieve_cookie(n){var i=null,s=n+"=";for(var t of document.cookie.split(";"))if(0==(t=t.trim()).indexOf(s)){i=t.substring(s.length,t.length);break}return e.log(`retrieved cookie ${n}: ${i}`),i}create_cookie(n,i,s,t,a,r){var o=new Date(Date.now()+1e3*s).toUTCString(),d=n+"="+encodeURIComponent(i)+(o?"; expires="+o:"")+(t?"; path="+t:"")+(a?"; domain="+a:"")+(r?"; SameSite=none; secure":"");document.cookie=d,e.log(`create cookie ${n}: ${i}`)}delete_cookie(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"}jsp(e,n){if(e.url&&n){var i=e.data||{};i[n]="XD"+this.jsc++,window[i[n]]=function(n){e.callback(n)};var s=e.url+"?"+this.jsp_params(i);this.jsp_get_script(s,(function(){window[i[n]]=void 0;try{delete window[i[n]]}catch(e){}}))}}jsp_params(e){var n=[];for(var i in e){var s=encodeURIComponent(i)+"="+encodeURIComponent(e[i]);n.push(s.replace("/%20/g","+"))}return n.join("&")}jsp_get_script(e,n){var i=document.createElement("script");i.type="text/javascript",i.src=e,i.onload=i.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(this.onload=this.onreadystatechange=null,document.getElementsByTagName("head")[0].removeChild(this),n())},document.getElementsByTagName("head")[0].appendChild(i)}static log(e){console.log(`[Sn Log] ${e}`)}random(e=3){return Math.floor(Math.random()*10**e+1)}}window.salmon_conf=window.salmon_conf||{is_sent_pv_ready:!0,is_sent_reading_time:!0,is_remote_log:!1,m_id:""},void 0===window.sn&&(window.sn=new e(window.salmon_conf)),"is_sent_pv_ready"in window.salmon_conf&&0==window.salmon_conf.is_sent_pv_ready||("interactive"==document.readyState?window.sn.send_page_view():document.addEventListener("DOMContentLoaded",(function(n){e.log("page ready!"),window.sn.send_page_view()}))),window.send_salmon_event=(e,n)=>{switch(e=e.split(".")[1]){case"page_view":window.sn.send_page_view(n.url,n.referrer,n.page);break;case"reading_pct":window.sn.send_reading_pct(n.pct);break;case"universal":window.sn.send_universal_event(n.category,n.action,n.label,n.value,n.page_order);break;case"privacy_agreement":window.sn.send_privacy_agreement(n.site);break;case"test":window.sn.send_event({ac:"test"});break;case"info":window.sn.send_event(n)}},window.sent_page_view=(e,n,i)=>{window.send_salmon_event("salmon.page_view",{url:e,referrer:n,page:i})},window.sent_reading_pct=e=>{window.send_salmon_event("salmon.reading_pct",{pct:e})},window.sent_universal_event=(e,n,i,s,t)=>{window.send_salmon_event("salmon.universal",{category:e,action:n,label:i,value:s,page_order:t})},window.snj_sent_privacy_agreement=e=>{window.send_salmon_event("salmon.privacy_agreement",{site:e})},window.snj_send_info=(e,n="")=>{window.send_salmon_event("salmon.info",e)}}();
